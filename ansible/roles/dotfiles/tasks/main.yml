---
# Dotfiles linking role using GNU Stow

- name: Ensure stow is installed
  package:
    name: stow
    state: present
  become: true

- name: Create directories that need to exist before stow runs
  file:
    path: "{{ user_home }}/{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - .config/lvim/spell
    - .tmux/plugins

- name: Create untracked zsh config
  file:
    path: "{{ dotfiles_dir }}/home/.config/zsh/untracked.zsh"
    state: touch
    mode: "0644"
    modification_time: preserve
    access_time: preserve

- name: Remove existing zsh config directory
  file:
    path: "{{ user_home }}/.config/zsh"
    state: absent

- name: Stow dotfiles
  command: stow --restow --target={{ user_home }} home
  args:
    chdir: "{{ dotfiles_dir }}"
  changed_when: false

- name: Stow keypocalypse-now configs
  command: stow --restow --target={{ user_home }} .config
  args:
    chdir: "{{ dotfiles_dir }}/home/keypocalypse-now"
  changed_when: false
