---
- name: Install Flutter dependencies
  become: true
  community.general.pacman:
    name:
      - mesa-utils  # For eglinfo
      - chromium    # Chrome for web development
    state: present

- name: Check if Flutter is already installed
  ansible.builtin.stat:
    path: "{{ ansible_facts['env']['HOME'] }}/flutter"
  register: flutter_dir

- name: Clone Flutter SDK from GitHub
  ansible.builtin.git:
    repo: https://github.com/flutter/flutter.git
    dest: "{{ ansible_facts['env']['HOME'] }}/flutter"
    version: stable
    depth: 1
  when: not flutter_dir.stat.exists

- name: Set Chrome executable environment variable
  ansible.builtin.lineinfile:
    path: "{{ ansible_facts['env']['HOME'] }}/.zshrc"
    line: 'export CHROME_EXECUTABLE=/usr/bin/chromium'
    create: yes

- name: Setup Android SDK for Flutter
  ansible.builtin.include_tasks: android.yml

- name: Check if Android SDK exists
  ansible.builtin.stat:
    path: "{{ ansible_facts['env']['HOME'] }}/Android/Sdk"
  register: android_sdk_dir

- name: Configure Flutter to use Android SDK
  ansible.builtin.shell: |
    {{ ansible_facts['env']['HOME'] }}/flutter/bin/flutter config --android-sdk "{{ ansible_facts['env']['HOME'] }}/Android/Sdk"
  args:
    executable: /bin/bash
  environment:
    PATH: "{{ ansible_facts['env']['HOME'] }}/flutter/bin:{{ ansible_facts['env']['PATH'] }}"
    ANDROID_HOME: "{{ ansible_facts['env']['HOME'] }}/Android/Sdk"
    ANDROID_SDK_ROOT: "{{ ansible_facts['env']['HOME'] }}/Android/Sdk"
  when: android_sdk_dir.stat.exists
  changed_when: true

- name: Run flutter doctor (initial check)
  ansible.builtin.shell: "{{ ansible_facts['env']['HOME'] }}/flutter/bin/flutter doctor"
  environment:
    PATH: "{{ ansible_facts['env']['HOME'] }}/flutter/bin:{{ ansible_facts['env']['PATH'] }}"
    CHROME_EXECUTABLE: /usr/bin/chromium
    ANDROID_HOME: "{{ ansible_facts['env']['HOME'] }}/Android/Sdk"
    ANDROID_SDK_ROOT: "{{ ansible_facts['env']['HOME'] }}/Android/Sdk"
  register: flutter_doctor_output
  changed_when: false
  failed_when: false

- name: Display flutter doctor output
  ansible.builtin.debug:
    var: flutter_doctor_output.stdout_lines
